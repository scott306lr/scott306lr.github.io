---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getEntriesForTag, getTagIndex } from '../../lib/tagIndex';
import FilterBar from '../../components/FilterBar.astro';
import PostCard from '../../components/PostCard.astro';
import ProjectCard from '../../components/ProjectCard.astro';

export async function getStaticPaths() {
	const tags = await getTagIndex();
	return tags.map((t) => ({ params: { tag: t.slug }, props: { tag: t } }));
}

const { tag } = Astro.props as { tag: { slug: string; label: string } };
const { posts, projects } = await getEntriesForTag(tag.slug);
---

<BaseLayout title={`Tag: ${tag.label}`} description={`Posts and projects tagged “${tag.label}”.`}>
	<h1 class="text-2xl font-bold tracking-tight">Tag: {tag.label}</h1>

	<FilterBar id="tag-filter" placeholder={`Filter in “${tag.label}”…`} />

	{posts.length ? (
		<section class="mt-8">
			<h2 class="text-lg font-semibold">Posts</h2>
			<div class="mt-4 grid gap-4" id="tag-posts-list">
				{posts.map((post) => (
					<PostCard
						post={post}
						compact
						filterText={[post.data.title, post.data.description, ...(post.data.tags ?? [])]
							.filter(Boolean)
							.join(' ')
							.toLowerCase()}
					/>
				))}
			</div>
		</section>
	) : null}

	{projects.length ? (

		<section class="mt-10">
			<h2 class="text-lg font-semibold">Projects</h2>
			<div class="mt-4 grid gap-4" id="tag-projects-list">
				{projects.map((project) => (
					<ProjectCard
						project={project}
						compact
						filterText={[project.data.title, project.data.summary, ...(project.data.tags ?? [])]
							.filter(Boolean)
							.join(' ')
							.toLowerCase()}
					/>
				))}
			</div>
		</section>
	) : null}

	{!posts.length && !projects.length ? <p class="mt-8 text-muted-foreground">Nothing here yet.</p> : null}


	<p id="tag-empty" class="mt-8 hidden text-sm text-muted-foreground">No matches.</p>

	<script is:inline>
		(function () {
			function init() {
				const input = document.getElementById('tag-filter');
				const empty = document.getElementById('tag-empty');
				if (!(input instanceof HTMLInputElement)) return;

				const items = Array.from(document.querySelectorAll('[data-filter-text]'));

				function apply() {
					const q = input.value.trim().toLowerCase();
					let visible = 0;
					for (const el of items) {
						const hay = (el.getAttribute('data-filter-text') ?? '').toLowerCase();
						const show = !q || hay.includes(q);
						el.classList.toggle('hidden', !show);
						if (show) visible++;
					}
					if (empty) empty.classList.toggle('hidden', visible !== 0);
				}

				if (input.dataset.bound !== 'true') {
					input.dataset.bound = 'true';
					input.addEventListener('input', apply);
				}

				apply();
			}

			document.addEventListener('astro:page-load', init);
		})();
	</script>
</BaseLayout>
