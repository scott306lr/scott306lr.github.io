---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getTagIndex } from '../../lib/tagIndex';
import FilterBar from '../../components/FilterBar.astro';

const tags = await getTagIndex();
---

<BaseLayout title="Tags" description="Browse by tag.">
	<h1 class="text-2xl font-bold tracking-tight">Tags</h1>
	<p class="mt-2 text-muted-foreground">Browse posts and projects by topic.</p>

	<FilterBar id="tags-filter" placeholder="Filter tags" />

	<ul class="mt-6 flex flex-wrap gap-2" id="tags-list">
		{tags.map((t) => (
			<li data-filter-text={`${t.label ?? ''} ${t.slug ?? ''}`.toLowerCase()}>
				<a
					href={`/tags/${t.slug}`}
					class="inline-flex items-center rounded-md border border-border bg-background px-2 py-1 text-sm no-underline hover:bg-accent hover:text-accent-foreground"
				>
					{t.label}
					<span class="ml-2 rounded-sm bg-muted px-1.5 py-0.5 text-xs text-muted-foreground">{t.count}</span>
				</a>
			</li>
		))}
	</ul>

	<p id="tags-empty" class="mt-6 hidden text-sm text-muted-foreground">No matches.</p>

	<script is:inline>
		(function () {
			function init() {
				const input = document.getElementById('tags-filter');
				const list = document.getElementById('tags-list');
				const empty = document.getElementById('tags-empty');
				if (!(input instanceof HTMLInputElement) || !list) return;

				const items = Array.from(list.querySelectorAll('[data-filter-text]'));

				function apply() {
					const q = input.value.trim().toLowerCase();
					let visible = 0;
					for (const el of items) {
						const hay = (el.getAttribute('data-filter-text') ?? '').toLowerCase();
						const show = !q || hay.includes(q);
						el.classList.toggle('hidden', !show);
						if (show) visible++;
					}
					if (empty) empty.classList.toggle('hidden', visible !== 0);
				}

				if (input.dataset.bound !== 'true') {
					input.dataset.bound = 'true';
					input.addEventListener('input', apply);
				}

				apply();
			}

			init();
			document.addEventListener('astro:page-load', init);
		})();
	</script>
</BaseLayout>
