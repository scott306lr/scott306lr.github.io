---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Search" description="Search posts and projects.">
	<h1 class="text-2xl font-bold tracking-tight">Search</h1>
	<p class="mt-2 text-muted-foreground">Type to search across posts and projects.</p>

	<div id="search" class="mt-6"></div>

	<script is:inline>
		// Pagefind UI (generated at build time into /pagefind)
		// eslint-disable-next-line no-undef
		function initPagefind() {
			const root = document.getElementById('search');
			if (!root) return;

			// Re-initialize whenever the Search page becomes active.

			if (!document.querySelector('link[href="/pagefind/pagefind-ui.css"]')) {
				const css = document.createElement('link');
				css.rel = 'stylesheet';
				css.href = '/pagefind/pagefind-ui.css';
				document.head.appendChild(css);
			}

			// If we re-enter this page via ClientRouter, the root div is new
			// but we may still have an existing Pagefind UI mounted.
			root.innerHTML = '';

			function mount() {
				// @ts-ignore
				new PagefindUI({
					element: '#search',
					showSubResults: true,
					processResult: (result) => result,
				});
			}

			if (window.PagefindUI) {
				mount();
				return;
			}

			const scriptSelector = 'script[src="/pagefind/pagefind-ui.js"]';
			const existingScript = document.querySelector(scriptSelector);
			if (!existingScript) {
				const script = document.createElement('script');
				script.src = '/pagefind/pagefind-ui.js';
				script.onload = mount;
				document.head.appendChild(script);
				return;
			}

			// Script already present (may still be loading). Don't stack listeners.
			if (existingScript.dataset.pagefindInit !== 'true') {
				existingScript.dataset.pagefindInit = 'true';
				existingScript.addEventListener('load', mount, { once: true });
			}
		}

		// Supports both full page load and ClientRouter navigations.
		// `astro:page-load` fires on initial load too.
		document.addEventListener('astro:page-load', initPagefind);
	</script>
</BaseLayout>
