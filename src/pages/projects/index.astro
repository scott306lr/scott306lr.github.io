---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { isNotDraft, sortByDateDesc } from '../../lib/content';
import FilterBar from '../../components/FilterBar.astro';
import ProjectCard from '../../components/ProjectCard.astro';

const projects = (await getCollection('projects')).filter(isNotDraft).sort(sortByDateDesc);
---

<BaseLayout title="Projects" description="Projects, experiments, and shipped things.">
	<h1 class="text-2xl font-semibold tracking-tight">Projects</h1>
	<p class="mt-2 text-sm text-muted-foreground">Projects, experiments, and shipped things.</p>

	<FilterBar id="projects-filter" placeholder="Filter projects (title, summary, tags)â€¦" />

	<div class="mt-6 grid gap-4" id="projects-list">
		{projects.map((project) => (
			<ProjectCard
				project={project}
				filterText={[project.data.title, project.data.summary, ...(project.data.tags ?? [])]
					.filter((v) => typeof v === 'string' && v.length > 0)
					.join(' ')
					.toLowerCase()}
			/>
		))}
	</div>

	<p id="projects-empty" class="mt-6 hidden text-sm text-muted-foreground">No matches.</p>

	<script is:inline>
		(function () {
			function init() {
				const input = document.getElementById('projects-filter');
				const list = document.getElementById('projects-list');
				const empty = document.getElementById('projects-empty');
				if (!(input instanceof HTMLInputElement) || !list) return;

				const items = Array.from(list.querySelectorAll('[data-filter-text]'));

				function apply() {
					const q = input.value.trim().toLowerCase();
					let visible = 0;
					for (const el of items) {
						const hay = (el.getAttribute('data-filter-text') ?? '').toLowerCase();
						const show = !q || hay.includes(q);
						el.classList.toggle('hidden', !show);
						if (show) visible++;
					}
					if (empty) empty.classList.toggle('hidden', visible !== 0);
				}

				if (input.dataset.bound !== 'true') {
					input.dataset.bound = 'true';
					input.addEventListener('input', apply);
				}

				apply();
			}

			init();
			document.addEventListener('astro:page-load', init);
		})();
	</script>
</BaseLayout>
