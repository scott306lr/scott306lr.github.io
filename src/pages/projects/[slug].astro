---
import ContentLayout from '../../layouts/ContentLayout.astro';
import { getCollection } from 'astro:content';
import { getGitLastUpdatedIso } from '../../lib/gitLastUpdated';
import { resolveEntrySourcePath } from '../../lib/entrySourcePath';
import { slugifyTag } from '../../lib/tags';

export async function getStaticPaths() {
	const projects = await getCollection('projects');
	return projects
		.filter((p) => !p.data.draft)
		.map((p) => ({ params: { slug: p.slug }, props: { project: p } }));
}

const { project } = Astro.props;

const entryPath = await resolveEntrySourcePath({
	cwdPathname: process.cwd(),
	collection: 'projects',
	slug: project.slug,
});
const lastUpdatedIso = entryPath ? await getGitLastUpdatedIso(entryPath) : null;
const lastUpdated = lastUpdatedIso ? new Date(lastUpdatedIso) : null;

const tags = (project.data.tags ?? []).map((t) => ({ label: t, slug: slugifyTag(t) }));

const { Content } = await project.render();
---

<ContentLayout
	title={project.data.title}
	description={project.data.summary}
	date={project.data.date}
	lastUpdated={lastUpdated}
	tags={tags}
>
	<Content />
</ContentLayout>
