---
import { ClientRouter } from 'astro:transitions';
import ThemeDropdown from '../components/ThemeDropdown.astro';
import UnderConstructionBanner from '../components/UnderConstructionBanner.astro';
import '../styles/global.css';

type Props = {
	title: string;
	description?: string;
};

const { title, description } = Astro.props;
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
		{description ? <meta name="description" content={description} /> : null}

		<ClientRouter />

		<script is:inline>
			(function () {
				const THEME_KEY = 'theme';
				const DEFAULT_THEME = 'system';
				const DARK_CLASS = 'dark';
				const MEDIA_QUERY = '(prefers-color-scheme: dark)';

				function getTheme() {
					const stored = localStorage.getItem(THEME_KEY);
					return stored === 'light' || stored === 'dark' || stored === 'system' ? stored : DEFAULT_THEME;
				}

				function isDarkTheme(theme) {
					return theme === 'dark';
				}

				function prefersDark() {
					return window.matchMedia(MEDIA_QUERY).matches;
				}

				function computeIsDark() {
					const theme = getTheme();
					return isDarkTheme(theme) || (theme === 'system' && prefersDark());
				}

				function applyThemeClass(doc, dark) {
					doc.documentElement.classList.toggle(DARK_CLASS, Boolean(dark));
				}

				function applyTheme() {
					applyThemeClass(document, computeIsDark());
				}

				// Initial load: run at parse-time.
				applyTheme();

				// View transitions: keep theme correct during swaps.
				document.addEventListener('astro:before-swap', (event) => {
					const dark = computeIsDark();
					applyThemeClass(document, dark);

					// Ensure the incoming document keeps the same theme class so it
					// doesn't flash default styles mid-transition.
					const nextDoc = event?.newDocument;
					if (nextDoc?.documentElement) applyThemeClass(nextDoc, dark);
				});

				document.addEventListener('astro:after-swap', applyTheme);
			})();
		</script>

		<script is:inline>
			const COPY_RESET_MS = 1200;
			const COPY_CODE_BUTTON_SELECTOR = 'button.code-copy';
			const CODE_BLOCK_SELECTOR = 'article pre:has(> code)';
			const GLOBAL_INIT_FLAG = '__codeCopyInit';
			const CONTENT_ROOT_SELECTOR = 'main#content';

			function getPreText(pre) {
				const code = pre.querySelector('code');
				const text = code ? code.textContent : pre.textContent;
				return (text || '').replace(/\n$/, '');
			}

			function copyIconSvg() {
				return `
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<rect x="9" y="9" width="13" height="13" rx="2" />
						<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
					</svg>
				`.trim();
			}

			function isWithinNoCopy(pre) {
				return Boolean(pre.closest('[data-no-code-copy]'));
			}

			function ensureCodeCopyButtons(root) {
				(root || document).querySelectorAll(CODE_BLOCK_SELECTOR).forEach((pre) => {
					if (!(pre instanceof HTMLElement)) return;
					if (isWithinNoCopy(pre)) return;
					if (pre.querySelector(COPY_CODE_BUTTON_SELECTOR)) return;
					if (!pre.querySelector('code')) return;

					const button = document.createElement('button');
					button.type = 'button';
					button.className = 'code-copy';
					button.setAttribute('aria-label', 'Copy code');
					button.setAttribute('title', 'Copy code');
					button.innerHTML = copyIconSvg();

					pre.append(button);
				});
			}

			function handleCopyClick(event) {
				const button = event.target instanceof Element ? event.target.closest(COPY_CODE_BUTTON_SELECTOR) : null;
				if (!button) return;

				const pre = button.closest('pre');
				if (!pre) return;

				const codeText = getPreText(pre);
				navigator.clipboard
					.writeText(codeText)
					.then(() => {
						button.setAttribute('aria-label', 'Copied');
						button.setAttribute('title', 'Copied');
						button.dataset.copied = 'true';

						window.setTimeout(() => {
							button.removeAttribute('data-copied');
							button.setAttribute('aria-label', 'Copy code');
							button.setAttribute('title', 'Copy code');
						}, COPY_RESET_MS);
					})
					.catch(() => {
						// Ignore copy failures.
					});
			}

			function initCodeCopy() {
				if (window[GLOBAL_INIT_FLAG]) return;
				window[GLOBAL_INIT_FLAG] = true;

				document.addEventListener('click', handleCopyClick);
			}

			function refreshCodeCopyButtons() {
				const root = document.querySelector(CONTENT_ROOT_SELECTOR) || document;
				ensureCodeCopyButtons(root);
			}

			initCodeCopy();
			refreshCodeCopyButtons();
			document.addEventListener('astro:page-load', refreshCodeCopyButtons);

		</script>


	</head>
	<body>
		<UnderConstructionBanner />
		<a
			href="#content"
			class="sr-only focus:not-sr-only focus:absolute focus:left-4 focus:top-4 focus:z-50 focus:rounded-md focus:bg-background focus:px-3 focus:py-2 focus:text-foreground focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background"
		>
			Skip to content
		</a>

		<header transition:persist class="sticky top-0 z-50 mt-10 border-b bg-background/80 backdrop-blur supports-[backdrop-filter]:bg-background/60">
			<script is:inline>
				(function () {
					const INIT_FLAG = '__navSameUrlGuardInit';
					if (window[INIT_FLAG]) return;
					window[INIT_FLAG] = true;

					function normalizePath(p) {
						return (p || '/').replace(/\/+$/, '') || '/';
					}

					document.addEventListener('click', (event) => {
						const link = event.target instanceof Element ? event.target.closest('a[href^="/"]') : null;
						if (!(link instanceof HTMLAnchorElement)) return;
						if (link.target && link.target !== '_self') return;
						if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return;
						if (event.button !== 0) return;

						const current = normalizePath(window.location.pathname);
						const next = normalizePath(link.pathname);
						if (current === next) {
							event.preventDefault();
						}
					});
				})();
			</script>

			<div class="mx-auto flex max-w-3xl items-center justify-between px-4 py-4">
				<nav class="flex items-center gap-4 text-sm">
					<a href="/" class="font-semibold no-underline hover:underline">Scott</a>
					<a href="/posts" class="text-muted-foreground no-underline hover:text-foreground">Posts</a>
					<a href="/projects" class="text-muted-foreground no-underline hover:text-foreground">Projects</a>
					<a href="/tags" class="text-muted-foreground no-underline hover:text-foreground">Tags</a>
					<a href="/search" class="text-muted-foreground no-underline hover:text-foreground">Search</a>
					<a href="/about" class="text-muted-foreground no-underline hover:text-foreground">About</a>
				</nav>
				<ThemeDropdown />
			</div>
		</header>

		<main id="content" class="mx-auto max-w-3xl px-4 py-10">
			<slot />
		</main>

		<footer class="border-t py-8 text-sm text-muted-foreground">
			<div class="mx-auto max-w-3xl px-4">
				<p>
					Â© {new Date().getFullYear()} Scott. Built with Astro.
				</p>
			</div>
		</footer>
	</body>
</html>
