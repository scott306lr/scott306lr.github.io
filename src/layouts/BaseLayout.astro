---
import { ClientRouter } from 'astro:transitions';
import ThemeDropdown from '../components/ThemeDropdown.astro';
import UnderConstructionBanner from '../components/UnderConstructionBanner.astro';
import '../styles/global.css';

type Props = {
	title: string;
	description?: string;
};

const { title, description } = Astro.props;
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
		{description ? <meta name="description" content={description} /> : null}

		<ClientRouter />

		<script is:inline>
			function applyTheme() {
				const key = 'theme';
				const stored = localStorage.getItem(key);
				const theme = stored === 'light' || stored === 'dark' || stored === 'system' ? stored : 'system';
				const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
				const isDark = theme === 'dark' || (theme === 'system' && prefersDark);
				document.documentElement.classList.toggle('dark', isDark);
			}

			applyTheme();
			document.addEventListener('astro:after-swap', applyTheme);
		</script>

		<script is:inline>
			const COPY_RESET_MS = 1200;
			const COPY_CODE_BUTTON_SELECTOR = 'button.code-copy';
			const CODE_BLOCK_SELECTOR = 'article pre:has(> code)';
			const CODE_COPY_INIT_FLAG = 'codeCopyInit';

			function getPreText(pre) {
				const code = pre.querySelector('code');
				const text = code ? code.textContent : pre.textContent;
				return (text || '').replace(/\n$/, '');
			}

			function copyIconSvg() {
				return `
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<rect x="9" y="9" width="13" height="13" rx="2" />
						<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
					</svg>
				`.trim();
			}

			let ensureQueued = false;
			function deferEnsure() {
				if (ensureQueued) return;
				ensureQueued = true;
				// Astro transitions can swap DOM multiple times; retry a few frames.
				let tries = 0;
				function tick() {
					tries += 1;
					ensureCodeCopyButtons(document);
					if (document.querySelector(CODE_BLOCK_SELECTOR + ':not(:has(' + COPY_CODE_BUTTON_SELECTOR + '))')) {
						if (tries < 5) requestAnimationFrame(tick);
						else ensureQueued = false;
						return;
					}
					ensureQueued = false;
				}
				requestAnimationFrame(tick);
			}

			function isCopyablePre(pre) {
				if (!(pre instanceof HTMLElement)) return false;
				if (pre.querySelector(COPY_CODE_BUTTON_SELECTOR)) return false;

				return Boolean(pre.querySelector('code'));
			}

			function isWithinNoCopy(pre) {
				return Boolean(pre.closest('[data-no-code-copy]'));
			}

			function ensureCodeCopyButtons(root) {
				(root || document).querySelectorAll(CODE_BLOCK_SELECTOR).forEach((pre) => {
					if (!isCopyablePre(pre)) return;
					if (isWithinNoCopy(pre)) return;

					const button = document.createElement('button');
					button.type = 'button';
					button.className = 'code-copy';
					button.setAttribute('aria-label', 'Copy code');
					button.setAttribute('title', 'Copy code');
					button.innerHTML = copyIconSvg();

					button.addEventListener('click', async () => {
						const codeText = getPreText(pre);
						try {
							await navigator.clipboard.writeText(codeText);
							button.setAttribute('aria-label', 'Copied');
							button.setAttribute('title', 'Copied');
							button.dataset.copied = 'true';
						} catch {
							return;
						}

						window.setTimeout(() => {
							button.removeAttribute('data-copied');
							button.setAttribute('aria-label', 'Copy code');
							button.setAttribute('title', 'Copy code');
						}, COPY_RESET_MS);
					});

					pre.append(button);
				});
			}

			function setupCodeCopyObserver() {
				if (window[CODE_COPY_INIT_FLAG]) return;
				window[CODE_COPY_INIT_FLAG] = true;

				deferEnsure();

				const observer = new MutationObserver(() => {
					deferEnsure();
				});

				observer.observe(document.documentElement, { childList: true, subtree: true });
				document.addEventListener('DOMContentLoaded', deferEnsure);
				document.addEventListener('astro:page-load', deferEnsure);
				document.addEventListener('astro:after-swap', deferEnsure);
				document.addEventListener('astro:before-swap', deferEnsure);
			}

			setupCodeCopyObserver();
		</script>


	</head>
	<body>
		<UnderConstructionBanner />
		<a
			href="#content"
			class="sr-only focus:not-sr-only focus:absolute focus:left-4 focus:top-4 focus:z-50 focus:rounded-md focus:bg-background focus:px-3 focus:py-2 focus:text-foreground focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background"
		>
			Skip to content
		</a>

		<header transition:persist class="sticky top-0 z-50 mt-10 border-b bg-background/80 backdrop-blur supports-[backdrop-filter]:bg-background/60">
			<div class="mx-auto flex max-w-3xl items-center justify-between px-4 py-4">
				<nav class="flex items-center gap-4 text-sm">
					<a href="/" class="font-semibold no-underline hover:underline">Scott</a>
					<a href="/posts" class="text-muted-foreground no-underline hover:text-foreground">Posts</a>
					<a href="/projects" class="text-muted-foreground no-underline hover:text-foreground">Projects</a>
					<a href="/tags" class="text-muted-foreground no-underline hover:text-foreground">Tags</a>
					<a href="/search" class="text-muted-foreground no-underline hover:text-foreground">Search</a>
					<a href="/about" class="text-muted-foreground no-underline hover:text-foreground">About</a>
				</nav>
				<ThemeDropdown />
			</div>
		</header>

		<main id="content" class="mx-auto max-w-3xl px-4 py-10">
			<slot />
		</main>

		<footer class="border-t py-8 text-sm text-muted-foreground">
			<div class="mx-auto max-w-3xl px-4">
				<p>
					Â© {new Date().getFullYear()} Scott. Built with Astro.
				</p>
			</div>
		</footer>
	</body>
</html>
